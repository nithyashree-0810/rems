<div class="container" *ngIf="!showRebookModal && !showEditForm">
  <!-- TITLE ONLY -->
  <h2>Booking History</h2>

  <!-- SEARCH + CREATE ROW -->
  <div class="search-create-row">
    <!-- SEARCH (CENTER) -->
    <div class="search-container">
      <input type="text"
             [(ngModel)]="searchLayoutName"
             (keyup)="onSearch()"
             placeholder="Search Layout Name"
             class="search-input">

      <input type="text"
             [(ngModel)]="searchPlotNo"
             (keyup)="onSearch()"
             placeholder="Search Plot No"
             class="search-input">

      <button class="search-btn" (click)="onSearch()">Search</button>
    </div>

    <!-- CREATE (RIGHT) -->
    <div class="top-buttons">
      <button class="btn btn-success" (click)="goToCreate()">
        <i class="fa fa-plus"></i> New Booking
      </button>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading">Loading bookings...</div>

  <!-- TABLE -->
  <div class="table-wrapper" *ngIf="!loading && bookingList.length > 0">
    <table class="layout-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Layout Name</th>
          <th>Plot No</th>
          <th>Customer</th>
          <th>Mobile</th>
          <th>Total Price</th>
          <th>Paid Amount</th>
          <th>Balance Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let b of paginatedBookings">
          <td>{{ b.bookingId }}</td>
          <td class="left-align">{{ b.layout?.layoutName }}</td>
          <td>{{ b.plot?.plotNo || b.plotNo }}</td>
          <td class="left-align">{{ b.customer?.firstName }}</td>
          <td>{{ b.customer?.mobileNo }}</td>
          <td>{{ b.price | currency:'INR' }}</td>
          <td>{{ getTotalPaid(b) | currency:'INR' }}</td>
          <td>{{ getBalance(b) | currency:'INR' }}</td>
          <td>{{ b.status }}</td>

          <!-- ACTION ICONS -->
          <td>
            <div class="action-icons">
              <!-- VIEW -->
              <i class="fa fa-eye circle-icon view"
                 [routerLink]="['/view-booking', b.bookingId]"
                 title="View"></i>

              <!-- EDIT (PAYMENT UPDATE) -->
              <button class="btn btn-edit-subtle"
                      (click)="openEditForm(b)">
                <i class="fa fa-pencil"></i> Edit
              </button>

              <!-- HISTORY -->
              <button class="btn btn-history"
                      (click)="viewHistory(b)"
                      title="View complete booking history for this plot">
                <i class="fa fa-clock-rotate-left"></i> History
              </button>

              <!-- DELETE -->
              <button class="btn btn-delete"
                      (click)="deleteBooking(b)"
                      title="Delete this booking">
                <i class="fa fa-trash"></i> Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- PAGINATION + HOME -->
  <div class="pagination-container" *ngIf="!loading && bookingList.length > 0">
    <div class="pagination">
      <button [disabled]="currentPage === 1" (click)="prevPage()">« Prev</button>

      <button *ngFor="let page of pages"
              [class.active]="page === currentPage"
              (click)="goToPage(page)">
        {{ page }}
      </button>

      <button [disabled]="currentPage === totalPages"
              (click)="nextPage()">Next »</button>
    </div>

    <button class="btn btn-danger pagination-home-btn"
            (click)="goHome()">
      Home
    </button>
  </div>

  <!-- NO DATA -->
  <div *ngIf="!loading && bookingList.length === 0" class="no-records">
    No bookings found.
  </div>
</div>

<!-- ================= EDIT FORM (PAYMENT UPDATE) ================= -->
<div class="page-bg" *ngIf="showEditForm">
  <div class="center-page">
    <div class="enquiry-card">
      <h3>Edit Payment Details</h3>

      <form #editForm="ngForm" (ngSubmit)="confirmUpdatePayment()">

        <div class="section-title">Owner Information (Readonly)</div>
        <div class="row">
          <div class="col">
            <label class="dark-label">Owner Name</label>
            <input type="text"
                   [value]="selectedBooking?.customer?.firstName"
                   readonly
                   class="readonly-input">
          </div>
          <div class="col">
            <label class="dark-label">Mobile Number</label>
            <input type="text"
                   [value]="selectedBooking?.customer?.mobileNo"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="section-title">Booking Details (Readonly)</div>
        <div class="row">
          <div class="col">
            <label class="dark-label">Layout Name</label>
            <input type="text"
                   [value]="selectedBooking?.layout?.layoutName"
                   readonly
                   class="readonly-input">
          </div>
          <div class="col">
            <label class="dark-label">Plot Number</label>
            <input type="text"
                   [value]="selectedBooking?.plot?.plotNo"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="section-title">Finance & Payment</div>
        <div class="row">
          <div class="col">
            <label class="dark-label">Total Plot Price</label>
            <input type="number"
                   [value]="selectedBooking?.price"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label class="dark-label">
              Total Paid Amount <span class="required">*</span>
            </label>
            <input type="number"
                   name="editPaidAmount"
                   [(ngModel)]="editPaidAmount"
                   (input)="calculateEditBalance()"
                   required>
          </div>
          <div class="col">
            <label class="dark-label">Balance Amount</label>
            <input type="number"
                   [value]="editBalance"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="buttons-row">
          <button type="submit"
                  class="btn btn-success"
                  [disabled]="!editForm.valid">
            Update Payment
          </button>
          <button type="button"
                  class="btn btn-danger"
                  (click)="closeEditForm()">
            Cancel
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ================= REBOOK FORM (OWNERSHIP CHANGE) ================= -->
<div class="page-bg" *ngIf="showRebookModal">
  <div class="center-page">
    <div class="enquiry-card">
      <h3>Rebooking Form (Ownership Change)</h3>

      <form #rebookForm="ngForm" (ngSubmit)="confirmRebook()">

        <div class="row">
          <div class="col">
            <label class="dark-label">Layout Name</label>
            <input type="text"
                   [value]="selectedBooking?.layout?.layoutName"
                   readonly
                   class="readonly-input">
          </div>
          <div class="col">
            <label class="dark-label">Plot Number</label>
            <input type="text"
                   [value]="selectedBooking?.plot?.plotNo"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="section-title">New Owner Details</div>

        <div class="row">
          <div class="col">
            <label class="dark-label">
              Owner ID <span class="required">*</span>
            </label>
            <input type="text"
                   name="newOwnerID"
                   [(ngModel)]="newOwnerID"
                   required>
          </div>
          <div class="col">
            <label class="dark-label">
              Owner Name <span class="required">*</span>
            </label>
            <input type="text"
                   name="newOwnerName"
                   [(ngModel)]="newOwnerName"
                   required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label class="dark-label">
              Mobile Number <span class="required">*</span>
            </label>
            <input type="text"
                   name="newOwnerMobile"
                   [(ngModel)]="newOwnerMobile"
                   required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label class="dark-label">
              Address <span class="required">*</span>
            </label>
            <textarea name="newOwnerAddress"
                      [(ngModel)]="newOwnerAddress"
                      required
                      class="full-width-textarea"></textarea>
          </div>
        </div>

        <div class="section-title">Pricing Section</div>

        <div class="row">
          <div class="col">
            <label class="dark-label">
              New Plot Price <span class="required">*</span>
            </label>
            <input type="number"
                   name="rebookPrice"
                   [(ngModel)]="rebookPrice"
                   (input)="calculateRebookBalance()"
                   required>
          </div>
          <div class="col">
            <label class="dark-label">Balance Amount</label>
            <input type="number"
                   [value]="rebookBalance"
                   readonly
                   class="readonly-input">
          </div>
        </div>

        <div class="buttons-row" style="margin-top: 30px;">
          <button type="submit"
                  class="btn btn-success"
                  [disabled]="!rebookForm.valid">
            Confirm Transfer
          </button>
          <button type="button"
                  class="btn btn-danger"
                  (click)="closeRebookForm()">
            Cancel
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
